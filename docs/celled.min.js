!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CellEd={})}(this,(function(t){"use strict";class e{constructor(){this.handlers={}}addHandler(t,e){const s=this.handlers;s[t]=s[t]||[],s[t].push(e)}removeHandler(t,e){const s=this.handlers[t];s&&e&&s.splice(s.indexOf(e),1)}emit(t,e){const s=this.handlers[t];s&&s.forEach((t=>{try{t(e)}catch(t){}}))}}function s(t){const e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild}function i(t,e,s){return t.addEventListener(e,s),function(t,e,s){return()=>t.removeEventListener(e,s)}(t,e,s)}function n(t,e,s){t.removeEventListener(e,s)}function l(t){t.parentNode&&t.parentElement.removeChild(t)}const o="ced",r=`${o}-grid-container`,h=`${o}-grid-container-scroll`,c=`${o}-grid`,a=`${o}-row`,d=`${o}-cell`,u=`${o}-select-cell`,p=`${o}-head`,f=`${o}-head-sticky`,m=`${o}-resizer`,v=`${o}-editing`,w=`${o}-active`,C=`${o}-selected`,g=`${o}-readonly`;class y{constructor(t,e,s){this.row=t,this.col=e,this.readonly=!1,this.isActive=!1,this.isSelected=!1,this.extraCss="",S(s)?this.val=String(s):(this.readonly=s.readonly,this.val=String(s.value),this.extraCss=s.css)}destroy(){}element(){if(!this.elem){const t=document.createElement("div");t.appendChild(E(this.val)),t.setAttribute("data-ci",String(this.col)),this.elem=t,this.setCss()}return this.elem}selected(){return this.isSelected}select(t=!0){return this.isSelected=t,this.setCss(),this}activate(t=!0){if(t)this.isActive=this.isSelected=!0;else if(this.isActive=!1,this.input){const t=this.val=this.input.value;this.input.blur(),l(this.input),this.elem.innerHTML="",this.elem.appendChild(E(t)),this.input=null}return this.setCss(),this}value(){return this.input?this.input.value:this.val}set(t){S(t)?this.setValue(t):(b(t.value)&&this.setValue(t.value),this.readonly=b(t.readonly)?t.readonly:this.readonly,this.extraCss=t.css,this.setCss())}setValue(t){this.val=String(t),this.input?this.input.value=t.toString():this.elem&&(this.elem.innerHTML="",this.elem.appendChild(E(t)))}setCss(){const t=d+A(this.readonly,g)+A(this.isActive,w)+A(this.isSelected,C)+A(!!this.input,v)+A(!!this.extraCss,this.extraCss);this.elem&&(this.elem.className=t)}startEdit(t,e=!1){if(this.readonly)return;const s=this.elem;this.input=t,t.value=s.textContent,e&&t.select(),t.style.width=s.offsetWidth-2+"px",s.innerHTML="",s.appendChild(t),t.focus(),this.setCss()}takesKey(){return!!this.input}takesMouse(){return this.takesKey()}}function E(t){const e=document.createElement("span");return e.appendChild(document.createTextNode(String(t))),e}class x{constructor(t,e,i,n){this.row=t,this.col=e,this.readonly=!1,this.options=null,this.isSelected=!1,this.extraCss="",this.readonly=i.readonly,this.options=i.options,this.elem=s(`<div data-ci="${e}"></div>`),this.selectElement=s("<select><select>"),function(t,e){for(let e=t.options.length;e>0;e--)t.remove(e);for(const s of e){const e=document.createElement("option");e.value=""+s,e.innerHTML=""+s,t.appendChild(e)}}(this.selectElement,this.options),this.set(""+i.value),this.elem.appendChild(this.selectElement),this.listener=()=>n(this),this.selectElement.addEventListener("change",this.listener),this.extraCss=i.css,this.setCss()}destroy(){this.selectElement.removeEventListener("change",this.listener),this.listener=null}element(){return this.elem}value(){return this.selectElement.value}set(t){S(t)?this.setValue(t):(b(t.value)&&this.setValue(t.value),this.extraCss=t.css,this.setCss())}setValue(t){this.selectElement.value=t?t.toString():null}setCss(){const t=d+" "+u+A(this.readonly,g)+A(this.isSelected,C)+A(!!this.extraCss,this.extraCss);this.elem.className=t}select(t=!0){return this.isSelected=t,this.setCss(),this}selected(){return this.isSelected}activate(t){return this}startEdit(t,e){}takesKey(){return!1}takesMouse(){return!0}}function S(t){return"string"==typeof t||"number"==typeof t}function b(t){return void 0!==t}function A(t,e){return t?" "+e:""}class ${constructor(t){this.cells=[],this.index=t.index,this.cells=t.cells.map(((e,s)=>{return i=this.index,n=s,l=e,o=t.updateValueCallback,"string"!=typeof l&&"number"!=typeof l&&Array.isArray(l.options)?new x(i,n,l,o):new y(i,n,l);var i,n,l,o}))}element(){if(!this.elem){const t=document.createElement("div");t.setAttribute("data-ri",String(this.index)),t.className=a,this.elem=t,this.cells.forEach((t=>this.elem.appendChild(t.element())))}return this.elem}}class H{constructor(t){this.options=t}rerender(t){const{grid:e,head:s}=this.options;e.innerHTML="",e.appendChild(s),t.forEach((t=>{e.appendChild(t.element())}))}destroy(){this.options=null}}class M{constructor(t){this.options=t}rerender(t){const{grid:e,head:s,container:i,gridContainer:n}=this.options;this.onScroll&&i.removeEventListener("scroll",this.onScroll);const l={viewportHeight:void 0,itemCount:void 0,start:void 0,end:void 0};let o=34;e.style.position="absolute";const r=r=>{const h=t.length,c=i.offsetHeight,a=h*o;let d=Math.floor(r/o)-4;d%2>0&&(d-=1),d=Math.max(0,d);let u=Math.ceil(c/o)+8;u=Math.min(h-d,u);const p=d+u-1,f=Math.max(0,a-c-4*o),m=Math.min(f,d*o),v=h-1,w=l.end===v&&p===v,C=l.start!==d||l.end!==p,g=c!==l.viewportHeight;if(h!==l.itemCount||g||C&&!w){const i=u*o;l.start=d,l.end=p,l.viewportHeight=c,l.itemCount=h,e.innerHTML="",e.appendChild(s);const r=e.offsetHeight;let f=0;const v=document.createDocumentFragment();let w=d;for(;w<=p&&w<t.length;++w){const e=t[w];v.appendChild(e.element())}for(e.appendChild(v),f=e.offsetHeight-r;f<i&&w<t.length;++w){const s=t[w].element();e.appendChild(s),f+=s.offsetHeight}const C=w-d;C&&(o=f/C),n.style.height=`${a}px`,e.style.top=`${m}px`}};let h;this.onScroll=t=>{h&&cancelAnimationFrame(h),h=requestAnimationFrame((()=>{r(t.target.scrollTop)}))},i.addEventListener("scroll",this.onScroll),r(i.scrollTop)}destroy(){this.options.container.removeEventListener("scroll",this.onScroll),this.options=null,this.onScroll=null}}function k(t){return"."+t}function I(t){return!1!==t}t.Grid=class{constructor(t,s){var i,n;this.rows=[],this.cells=[],this.events=new e,this.cleanups=[],this.container="string"==typeof t?(i=t,n||(n=i,i=document),i.querySelector(n)):t,s&&this.init(s)}init(t){this.destroy(),t.scroll=function(t){const e=t.scroll;if(!e)return{};return{enabled:I(e.enabled),virtualScroll:I(e.virtualScroll),stickyHeader:I(e.stickyHeader)}}(t),this.options=t;const e=this.container,i=this.rows;e.innerHTML="",i.length=0,t.input?(this.cellInput="function"==typeof t.input?t.input():t.input,l(this.cellInput)):this.cellInput=s('<input id="celled-cell-input" type="text" >'),this.hiddenInput=s('<div id="celled-hidden-input" style="position:absolute; z-index:-1; left:2px; top: 2px;" contenteditable tabindex="0"></div>'),t.scroll&&e.classList.add(h);const n=s(`<div class="${r}"></div>`),o=t.scroll.stickyHeader,d=s(`<div class="${`${a} ${p} ${o?f:""}`}"></div>`),u=this.grid=s(`<div class="${c}"></div>`);e.appendChild(n),n.appendChild(this.hiddenInput),n.appendChild(u),t.cols.forEach(((t,e)=>d.appendChild(this.createHeadCell(t,e))));const m={container:e,gridContainer:n,grid:u,head:d};this.render=t.scroll.virtualScroll?new M(m):new H(m),this.createRows(),this.initMouse(),this.initKeys(),this.initClipboard(),this.resetColumnWidths();const v=new ResizeObserver((()=>{this.updateColumnWidths()}));v.observe(e),this.cleanups.push((()=>v.disconnect()))}destroy(){this.render&&(this.render.destroy(),this.render=null),this.cleanups.forEach((t=>t())),this.cleanups.length=0,this.grid&&l(this.grid),this.cells.forEach((t=>t.destroy())),this.cells.length=0,this.rows.length=0,this.grid=null,this.hiddenInput=null,this.cellInput=null,this.events=new e}on(t,e){this.events.addHandler(t,e)}update(t,e,s,i){const n=this.rows[t].cells[e];n&&(n.set(s),this.updateValue(n,i))}addRows(t){[].push.apply(this.options.rows,t),t.forEach((t=>{this.createAndAddRow(t).cells.forEach((t=>this.emitInput(t)))})),this.flattenCells(),this.renderRows()}addRow(){this.addRows([this.options.cols.map((t=>""))])}resetColumnWidths(){const t=this.getHeadCells();if(!t.length)return;const e=t[0].parentElement.offsetWidth;let s=0,i=0;t.forEach(((t,e)=>{const n=this.options.cols[e];if(!t.style.width&&"object"==typeof n&&n.width){const e=n.width,l="string"==typeof e?e:`${e}px`;t.style.width=l,s+=t.offsetWidth,i+=1}}));const n=e-s,l=t.length-i;l>0&&t.forEach(((t,e)=>{if(!t.style.width){const e=n/l;t.style.width=`${e}px`}})),t.forEach(((t,e)=>{t.setAttribute("data-width",String(t.offsetWidth))}))}updateColumnWidths(){const t=this.getHeadCells(),e=t.map((t=>+t.getAttribute("data-width")||0)),s=e.reduce(((t,e)=>e+t),0),i=t.reduce(((t,e)=>e.offsetWidth+t),0)/s;t.forEach(((t,s)=>{t.style.width=e[s]*i+"px"})),t.forEach(((t,e)=>{t.setAttribute("data-width",String(t.offsetWidth))}))}getHeadCells(){return t=this.container,(e=`${k(p)} ${k(d)}`)||(e=t,t=document),[].slice.call(t.querySelectorAll(e));var t,e}createHeadCell(t,e){const l="object"==typeof t?t.name:t,o=s(`<div class="${d}" data-ci="${e}"><span>${l}</span></div>`),r=s(`<div class="${m}"></div>`);o.appendChild(r);let h=null,c=null,a=null,u=null,p=null;const f=t=>{if(p){let s=t.target;for(;s;){const t=s.getAttribute("data-ci"),i=+t;if(null!==t&&!isNaN(i)){const t=Math.min(e,i),s=Math.max(e,i);p[0]===t&&p[1]===s||(p=[t,s],this.cells.forEach((e=>e.select(e.col>=t&&e.col<=s))),this.emitSelect());break}s=s.parentElement}}else{const e=t.pageX-h;c&&(c.style.width=u-e+"px"),o.style.width=a+e+"px"}},v=()=>{h=null,p=null,n(document,"mousemove",f),n(document,"mouseup",v),this.resetColumnWidths()},w=i(o,"mousedown",(t=>{if(t.target===r)c=o.nextElementSibling,h=t.pageX,a=o.offsetWidth,u=c?c.offsetWidth:null;else if(this.rows.length){const t=+o.getAttribute("data-ci");p=!0,this.cells.forEach((e=>e.activate(!1).select(e.col===t))),p=[t,t],this.focusHiddenInput(),this.activeCell=this.rows[0].cells[t],this.emitSelect()}i(document,"mouseup",v),i(document,"mousemove",f),t.preventDefault()}));return this.cleanups.push(w),o}focusHiddenInput(){this.hiddenInput.focus({preventScroll:!0})}createAndAddRow(t){const e=new $({index:this.rows.length,cells:t,updateValueCallback:t=>this.emitInput(t)});return this.rows.push(e),e}createRows(){this.rows=[],this.options.rows.forEach((t=>this.createAndAddRow(t))),this.flattenCells(),this.renderRows()}renderRows(){this.render.rerender(this.rows)}flattenCells(){this.cells=[];for(let t=0,e=this.rows.length;t<e;++t)this.cells.push(...this.rows[t].cells)}initMouse(){let t,e,s=null;const l=(t,e,s,i)=>""+t+e+s+i,o=(t,e=0)=>{if(!t||!t.parentElement)return;const s=t.getAttribute("data-ci");if(null===s&&e<2)return o(t.parentElement,e+1);const i=t.parentElement.getAttribute("data-ri"),n=+s,l=+i;return s&&i&&!isNaN(n)&&!isNaN(l)?this.rows[l].cells[n]:void 0},r=t=>{const e=t.target;return o(e)},h=i=>{const n=r(i);if(n){const i=n.row,o=n.col,r=Math.min(i,e),h=Math.max(i,e),c=Math.min(o,t),a=Math.max(o,t),d=l(r,c,h,a);if(s!==d){s=d,this.unselect();for(let t=r;t<=h;++t)for(let e=c;e<=a;++e)this.rows[t].cells[e].select();this.emitSelect()}}},c=()=>{n(document,"mousemove",h),n(document,"mouseup",c)};let a=Date.now();const d=i(this.grid,"mousedown",(n=>{const o=r(n);if(o){const r=Date.now()-a;if(a=Date.now(),o.takesMouse())return;if(o===this.activeCell&&!o.readonly&&r<300)o.startEdit(this.cellInput),this.emitFocus();else{const n=o.row,r=o.col;e=n,t=r,s=l(n,r,n,r),this.activate(o),i(document,"mouseup",c),i(document,"mousemove",h)}n.preventDefault()}}));this.cleanups.push(d);const u=i(document,"mouseup",(t=>{if(this.activeCell){for(let e=t.target;e;e=e.parentNode)if(e===this.container)return;this.activeCell.activate(!1),this.unselect()&&this.emitSelect()}}));this.cleanups.push(u)}activate(t,e=!0){this.activeCell&&this.activeCell.activate(!1);let s=!1;this.cells.forEach((i=>{s=i===t?i.selected()!==e:s||i.selected(),i.select(!1)})),this.activeCell=t.select(e).activate(e),s&&this.emitSelect(),this.focusHiddenInput()}moveActive(t,e,s=!1){const i=this.activeCell;if(i){const n=this.rows,l=i.row+t;for(;s&&this.options.canAddRows&&l>=n.length;)this.addRow();const o=n[l];if(o){const t=o.cells[i.col+e];t&&this.activate(t)}}}initKeys(){const t=this.hiddenInput,e=this.cellInput;this.cleanups.push(i(t,"keydown",(t=>{const e=(t=t||window.event).keyCode;46===e&&(this.cells.forEach((t=>{t.selected()&&this.setCell(t,"")})),t.preventDefault()),37===e&&this.moveActive(0,-1),38===e&&this.moveActive(-1,0),39===e&&this.moveActive(0,1),40===e&&this.moveActive(1,0)})));this.cleanups.push(i(e,"input",(t=>{const e=this.activeCell;e&&!e.readonly&&e.takesKey()&&(this.updateValue(e,!0),this.cells.forEach((t=>{t.selected()&&this.setCell(t,e.value())})))}))),this.cleanups.push(i(e,"keydown",(t=>{13===t.keyCode&&(this.moveActive(0,0),this.moveActive(1,0,!0),t.preventDefault()),27===t.keyCode&&(this.moveActive(0,0),t.preventDefault())}))),this.cleanups.push(i(t,"keypress",(t=>{const s=this.activeCell;!s||s.readonly||s.takesKey()?t.preventDefault():(s.startEdit(e,!0),this.emitFocus())})))}pasteCSV(t,e,s,i){const n=function(t,e){const s=[];let i=!1;for(let n=0,l=0,o=0;o<t.length;o++){const r=t[o],h=t[o+1];s[n]=s[n]||[],s[n][l]=s[n][l]||"",'"'===r&&i&&'"'===h?(s[n][l]+=r,++o):'"'!==r?r!==e||i?"\r"!==r||"\n"!==h||i?"\n"!==r&&"\r"!==r||i?s[n][l]+=r:(++n,l=0):(++n,l=0,++o):++l:i=!i}return s}(t,e),l=this.activeCell;isNaN(s)&&!l||(s=isNaN(s)?l.row:s,i=isNaN(i)?l.col:i,n.forEach(((t,e)=>{let n=this.rows[s+e];if(!n&&this.options.canAddRows){const t=this.rows[s];this.addRows([t.cells.map((t=>""))]),n=this.rows[s+e]}const l=i,o=1===t.length&&""===t[0];n&&!o&&t.forEach(((t,e)=>{const s=n.cells[l+e];s&&!s.readonly&&(this.setCell(s,t),s.select())}))})))}initClipboard(){const t=i(this.hiddenInput,"paste",(t=>{t.preventDefault();const e=(t.clipboardData||window.clipboardData).getData("text");this.pasteCSV(e,"\t")})),e=i(this.hiddenInput,"copy",(t=>{t.preventDefault();const e=[];for(const t of this.rows){const s=t.cells.filter((t=>t.selected()));if(s.length>0)e.push(s.map((t=>t.value())));else if(e.length)break}(t.clipboardData||window.clipboardData).setData("text/plain",function(t,e,s="\n"){let i="";return t.forEach(((t,n)=>{n>0&&(i+=s),t.forEach(((t,s)=>{(t=t.replace(/"/g,'""')).search(/("|,|\n)/g)>=0&&(t='"'+t+'"'),s>0&&(i+=e),i+=t}))})),i}(e,"\t"))}));this.cleanups.push(t),this.cleanups.push(e)}setCell(t,e){t.readonly||(t.set(e),this.updateValue(t,!0))}unselect(){let t=!1;return this.cells.forEach((e=>{t=t||e.selected(),e.select(!1)})),t}updateValue(t,e){const s=t.col,i=this.options.rows[t.row],n=i[s];"string"==typeof n||"number"==typeof n?i[s]=t.value():n.value=t.value(),e&&this.emitInput(t)}emitInput(t){this.events.emit("input",{grid:this,col:t.col,row:t.row,value:t.value()})}emitFocus(){const t=this.activeCell;this.events.emit("focus",{grid:this,col:t.col,row:t.row,value:t.value()})}emitSelect(){this.events.emit("select",{grid:this,selection:this.cells.filter((t=>t.selected())).map((t=>({row:t.row,col:t.col})))})}}}));
//# sourceMappingURL=celled.min.js.map
