!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).CellEd={})}(this,(function(t){"use strict";var e=function(){function t(){this.handlers={}}return t.prototype.addHandler=function(t,e){var n=this.handlers;n[t]=n[t]||[],n[t].push(e)},t.prototype.removeHandler=function(t,e){var n=this.handlers[t];n&&e&&n.splice(n.indexOf(e),1)},t.prototype.emit=function(t,e){var n=this.handlers[t];n&&n.forEach((function(t){try{t(e)}catch(t){}}))},t}();function n(t){var e=document.createElement("div");return e.innerHTML=t.trim(),e.firstChild}function i(t,e,n){return t.addEventListener(e,n),function(t,e,n){return function(){return t.removeEventListener(e,n)}}(t,e,n)}function s(t,e,n){t.removeEventListener(e,n)}function o(t){t.parentNode&&t.parentElement.removeChild(t)}var r=function(){function t(t,e,n){this.row=t,this.col=e,this.readonly=!1,this.isActive=!1,this.isSelected=!1,this.extraCss="",c(n)?this.val=String(n):(this.readonly=n.readonly,this.val=String(n.value),this.extraCss=n.css)}return t.prototype.destroy=function(){},t.prototype.element=function(){if(!this.elem){var t=document.createElement("div");t.appendChild(l(this.val)),t.setAttribute("data-ci",String(this.col)),this.elem=t,this.setCss()}return this.elem},t.prototype.selected=function(){return this.isSelected},t.prototype.select=function(t){return void 0===t&&(t=!0),this.isSelected=t,this.setCss(),this},t.prototype.activate=function(t){return void 0===t&&(t=!0),t?this.isActive=this.isSelected=!0:(this.isActive=!1,this.input&&(this.input.blur(),o(this.input),this.elem.innerHTML="",this.elem.appendChild(l(this.input.value)),this.input=null)),this.setCss(),this},t.prototype.value=function(){return this.input?this.input.value:this.val},t.prototype.set=function(t){c(t)?this.setValue(t):(u(t.value)&&this.setValue(t.value),this.readonly=u(t.readonly)?t.readonly:this.readonly,this.extraCss=t.css,this.setCss())},t.prototype.setValue=function(t){this.val=String(t),this.input?this.input.value=t.toString():this.elem&&(this.elem.innerHTML="",this.elem.appendChild(l(t)))},t.prototype.setCss=function(){var t="ced-cell"+h(this.readonly,"ced-readonly")+h(this.isActive,"ced-active")+h(this.isSelected,"ced-selected")+h(!!this.input,"ced-editing")+h(!!this.extraCss,this.extraCss);this.elem&&(this.elem.className=t)},t.prototype.startEdit=function(t,e){if(void 0===e&&(e=!1),!this.readonly){var n=this.elem;this.input=t,t.value=n.textContent,e&&t.select(),t.style.width=n.offsetWidth-2+"px",n.innerHTML="",n.appendChild(t),t.focus(),this.setCss()}},t.prototype.takesKey=function(){return!!this.input},t.prototype.takesMouse=function(){return this.takesKey()},t}();function l(t){var e=document.createElement("span");return e.appendChild(document.createTextNode(String(t))),e}var a=function(){function t(t,e,i,s){var o=this;this.row=t,this.col=e,this.readonly=!1,this.options=null,this.isSelected=!1,this.extraCss="",this.readonly=i.readonly,this.options=i.options,this.elem=n('<div data-ci="'+e+'"></div>'),this.selectElement=n("<select><select>"),function(t,e){for(var n=t.options.length;n>0;n--)t.remove(n);for(var i=0,s=e;i<s.length;i++){var o=s[i],r=document.createElement("option");r.value=""+o,r.innerHTML=""+o,t.appendChild(r)}}(this.selectElement,this.options),this.set(""+i.value),this.elem.appendChild(this.selectElement),this.listener=function(){return s(o)},this.selectElement.addEventListener("change",this.listener),this.extraCss=i.css,this.setCss()}return t.prototype.destroy=function(){this.selectElement.removeEventListener("change",this.listener),this.listener=null},t.prototype.element=function(){return this.elem},t.prototype.value=function(){return this.selectElement.value},t.prototype.set=function(t){c(t)?this.setValue(t):(u(t.value)&&this.setValue(t.value),this.extraCss=t.css,this.setCss())},t.prototype.setValue=function(t){this.selectElement.value=t?t.toString():null},t.prototype.setCss=function(){var t="ced-cell ced-select-cell"+h(this.readonly,"ced-readonly")+h(this.isSelected,"ced-selected")+h(!!this.extraCss,this.extraCss);this.elem.className=t},t.prototype.select=function(t){return void 0===t&&(t=!0),this.isSelected=t,this.setCss(),this},t.prototype.selected=function(){return this.isSelected},t.prototype.activate=function(t){return this},t.prototype.startEdit=function(t,e){},t.prototype.takesKey=function(){return!1},t.prototype.takesMouse=function(){return!0},t}();function c(t){return"string"==typeof t||"number"==typeof t}function u(t){return void 0!==t}function h(t,e){return t?" "+e:""}var d=function(){function t(t){var e=this;this.cells=[],this.index=t.index,this.cells=t.cells.map((function(n,i){return s=e.index,o=i,l=n,c=t.updateValueCallback,"string"!=typeof l&&"number"!=typeof l&&Array.isArray(l.options)?new a(s,o,l,c):new r(s,o,l);var s,o,l,c}))}return t.prototype.element=function(){var t=this;if(!this.elem){var e=document.createElement("div");e.setAttribute("data-ri",String(this.index)),e.className="ced-row",this.elem=e,this.cells.forEach((function(e){return t.elem.appendChild(e.element())}))}return this.elem},t}(),p=function(){function t(t){this.options=t}return t.prototype.rerender=function(t){var e=this.options,n=e.grid,i=e.head;n.innerHTML="",n.appendChild(i),t.forEach((function(t){n.appendChild(t.element())}))},t.prototype.destroy=function(){this.options=null},t}(),f=function(){function t(t){this.options=t}return t.prototype.rerender=function(t){var e=this.options,n=e.grid,i=e.head,s=e.container,o=e.gridContainer;this.onScroll&&s.removeEventListener("scroll",this.onScroll);var r={viewportHeight:void 0,itemCount:void 0,start:void 0,end:void 0},l=34;n.style.position="absolute";var a,c=function(e){var a=t.length,c=s.offsetHeight,u=a*l,h=Math.floor(e/l)-4;h%2>0&&(h-=1),h=Math.max(0,h);var d=Math.ceil(c/l)+8,p=h+(d=Math.min(a-h,d))-1,f=Math.max(0,u-c-4*l),v=Math.min(f,h*l),m=a-1,y=r.end===m&&p===m,C=r.start!==h||r.end!==p,w=c!==r.viewportHeight;if(a!==r.itemCount||w||C&&!y){var g=d*l;r.start=h,r.end=p,r.viewportHeight=c,r.itemCount=a,n.innerHTML="",n.appendChild(i);for(var E=n.offsetHeight,x=0,S=document.createDocumentFragment(),b=h;b<=p&&b<t.length;++b){var A=t[b];S.appendChild(A.element())}for(n.appendChild(S),x=n.offsetHeight-E;x<g&&b<t.length;++b){var H=(A=t[b]).element();n.appendChild(H),x+=H.offsetHeight}var M=b-h;M&&(l=x/M),o.style.height=u+"px",n.style.top=v+"px"}};this.onScroll=function(t){a&&cancelAnimationFrame(a),a=requestAnimationFrame((function(){c(t.target.scrollTop)}))},s.addEventListener("scroll",this.onScroll),c(s.scrollTop)},t.prototype.destroy=function(){this.options.container.removeEventListener("scroll",this.onScroll),this.options=null,this.onScroll=null},t}(),v=function(){function t(t,n){var i,s;this.rows=[],this.cells=[],this.events=new e,this.cleanups=[],this.container="string"==typeof t?(i=t,s||(s=i,i=document),i.querySelector(s)):t,n&&this.init(n)}return t.prototype.init=function(t){var e=this;this.destroy(),t.scroll=function(t){var e=t.scroll;if(!e)return{};return{enabled:y(e.enabled),virtualScroll:y(e.virtualScroll),stickyHeader:y(e.stickyHeader)}}(t),this.options=t;var i=this.container,s=this.rows;i.innerHTML="",s.length=0,t.input?(this.cellInput="function"==typeof t.input?t.input():t.input,o(this.cellInput)):this.cellInput=n('<input id="celled-cell-input" type="text" >'),this.hiddenInput=n('<div id="celled-hidden-input" style="position:absolute; z-index:-1; left:2px; top: 2px;" contenteditable tabindex="0"></div>'),t.scroll&&i.classList.add("ced-grid-container-scroll");var r=n('<div class="ced-grid-container"></div>'),l=n('<div class="'+("ced-row ced-head "+(t.scroll.stickyHeader?"ced-head-sticky":""))+'"></div>'),a=this.grid=n('<div class="ced-grid"></div>');i.appendChild(r),r.appendChild(this.hiddenInput),r.appendChild(a),t.cols.forEach((function(t,n){return l.appendChild(e.createHeadCell(t,n))}));var c={container:i,gridContainer:r,grid:a,head:l};this.render=t.scroll.virtualScroll?new f(c):new p(c),this.createRows(),this.initMouse(),this.initKeys(),this.initClipboard(),this.resetColumnWidths()},t.prototype.destroy=function(){this.render&&(this.render.destroy(),this.render=null),this.cleanups.forEach((function(t){return t()})),this.cleanups.length=0,this.grid&&o(this.grid),this.cells.forEach((function(t){return t.destroy()})),this.cells.length=0,this.rows.length=0,this.grid=null,this.hiddenInput=null,this.cellInput=null,this.events=new e},t.prototype.on=function(t,e){this.events.addHandler(t,e)},t.prototype.update=function(t,e,n,i){var s=this.rows[t].cells[e];s&&(s.set(n),this.updateValue(s,i))},t.prototype.addRows=function(t){var e=this;[].push.apply(this.options.rows,t),t.forEach((function(t){e.createAndAddRow(t).cells.forEach((function(t){return e.emitInput(t)}))})),this.flattenCells(),this.renderRows()},t.prototype.addRow=function(){this.addRows([this.options.cols.map((function(t){return""}))])},t.prototype.resetColumnWidths=function(){var t,e;(t=this.container,(e=m("ced-head")+" "+m("ced-cell"))||(e=t,t=document),[].slice.call(t.querySelectorAll(e))).forEach((function(t,e){t.style.width=t.offsetWidth+"px"}))},t.prototype.createHeadCell=function(t,e){var o=this,r=n('<div class="ced-cell" data-ci="'+e+'"><span>'+t+"</span></div>"),l=n('<div class="ced-resizer"></div>');r.appendChild(l);var a=null,c=null,u=null,h=null,d=null,p=function(t){if(d)for(var n=t.target,i=function(){var t=n.getAttribute("data-ci"),i=+t;if(null!==t&&!isNaN(i)){var s=Math.min(e,i),r=Math.max(e,i);return d[0]===s&&d[1]===r||(d=[s,r],o.cells.forEach((function(t){return t.select(t.col>=s&&t.col<=r)})),o.emitSelect()),"break"}n=n.parentElement};n;){if("break"===i())break}else{var s=t.pageX-a;c&&(c.style.width=h-s+"px"),r.style.width=u+s+"px"}},f=function(){a=null,d=null,s(document,"mousemove",p),s(document,"mouseup",f),o.resetColumnWidths()},v=i(r,"mousedown",(function(t){if(t.target===l)c=r.nextElementSibling,a=t.pageX,u=r.offsetWidth,h=c?c.offsetWidth:null;else if(o.rows.length){var e=+r.getAttribute("data-ci");d=!0,o.cells.forEach((function(t){return t.activate(!1).select(t.col===e)})),d=[e,e],o.focusHiddenInput(),o.activeCell=o.rows[0].cells[e],o.emitSelect()}i(document,"mouseup",f),i(document,"mousemove",p),t.preventDefault()}));return this.cleanups.push(v),r},t.prototype.focusHiddenInput=function(){this.hiddenInput.focus({preventScroll:!0})},t.prototype.createAndAddRow=function(t){var e=this,n=new d({index:this.rows.length,cells:t,updateValueCallback:function(t){return e.emitInput(t)}});return this.rows.push(n),n},t.prototype.createRows=function(){var t=this;this.rows=[],this.options.rows.forEach((function(e){return t.createAndAddRow(e)})),this.flattenCells(),this.renderRows()},t.prototype.renderRows=function(){this.render.rerender(this.rows)},t.prototype.flattenCells=function(){var t;this.cells=[];for(var e=0,n=this.rows.length;e<n;++e)(t=this.cells).push.apply(t,this.rows[e].cells)},t.prototype.initMouse=function(){var t,e,n=this,o=null,r=function(t,e,n,i){return""+t+e+n+i},l=function(t,e){if(void 0===e&&(e=0),t&&t.parentElement){var i=t.getAttribute("data-ci");if(null===i&&e<2)return l(t.parentElement,e+1);var s=t.parentElement.getAttribute("data-ri"),o=+i,r=+s;return i&&s&&!isNaN(o)&&!isNaN(r)?n.rows[r].cells[o]:void 0}},a=function(t){var e=t.target;return l(e)},c=function(i){var s=a(i);if(s){var l=s.row,c=s.col,u=Math.min(l,e),h=Math.max(l,e),d=Math.min(c,t),p=Math.max(c,t),f=r(u,d,h,p);if(o!==f){o=f,n.unselect();for(var v=u;v<=h;++v)for(var m=d;m<=p;++m)n.rows[v].cells[m].select();n.emitSelect()}}},u=function(){s(document,"mousemove",c),s(document,"mouseup",u)},h=Date.now(),d=i(this.grid,"mousedown",(function(s){var l=a(s);if(l){var d=Date.now()-h;if(h=Date.now(),l.takesMouse())return;if(l===n.activeCell&&!l.readonly&&d<300)l.startEdit(n.cellInput),n.emitFocus();else{var p=l.row,f=l.col;e=p,t=f,o=r(p,f,p,f),n.activate(l),i(document,"mouseup",u),i(document,"mousemove",c)}s.preventDefault()}}));this.cleanups.push(d);var p=i(document,"mouseup",(function(t){if(n.activeCell){for(var e=t.target;e;e=e.parentNode)if(e===n.container)return;n.activeCell.activate(!1),n.unselect()&&n.emitSelect()}}));this.cleanups.push(p)},t.prototype.activate=function(t,e){void 0===e&&(e=!0),this.activeCell&&this.activeCell.activate(!1);var n=!1;this.cells.forEach((function(i){n=i===t?i.selected()!==e:n||i.selected(),i.select(!1)})),this.activeCell=t.select(e).activate(e),n&&this.emitSelect(),this.focusHiddenInput()},t.prototype.moveActive=function(t,e,n){void 0===n&&(n=!1);var i=this.activeCell;if(i){for(var s=this.rows,o=i.row+t;n&&this.options.canAddRows&&o>=s.length;)this.addRow();var r=s[o];if(r){var l=r.cells[i.col+e];l&&this.activate(l)}}},t.prototype.initKeys=function(){var t=this,e=this.hiddenInput,n=this.cellInput;this.cleanups.push(i(e,"keydown",(function(e){var n=(e=e||window.event).keyCode;46===n&&(t.cells.forEach((function(e){e.selected()&&t.setCell(e,"")})),e.preventDefault()),37===n&&t.moveActive(0,-1),38===n&&t.moveActive(-1,0),39===n&&t.moveActive(0,1),40===n&&t.moveActive(1,0)})));this.cleanups.push(i(n,"input",(function(e){var n=t.activeCell;n&&!n.readonly&&n.takesKey()&&(t.updateValue(n,!0),t.cells.forEach((function(e){e.selected()&&e!==n&&t.setCell(e,n.value())})))}))),this.cleanups.push(i(n,"keydown",(function(e){13===e.keyCode&&(t.moveActive(0,0),t.moveActive(1,0,!0),e.preventDefault()),27===e.keyCode&&(t.moveActive(0,0),e.preventDefault())}))),this.cleanups.push(i(e,"keypress",(function(e){var i=t.activeCell;!i||i.readonly||i.takesKey()?e.preventDefault():(i.startEdit(n,!0),t.emitFocus())})))},t.prototype.pasteCSV=function(t,e,n,i){var s=this,o=function(t,e){for(var n=[],i=!1,s=0,o=0,r=0;r<t.length;r++){var l=t[r],a=t[r+1];n[s]=n[s]||[],n[s][o]=n[s][o]||"",'"'===l&&i&&'"'===a?(n[s][o]+=l,++r):'"'!==l?l!==e||i?"\r"!==l||"\n"!==a||i?"\n"!==l&&"\r"!==l||i?n[s][o]+=l:(++s,o=0):(++s,o=0,++r):++o:i=!i}return n}(t,e),r=this.activeCell;isNaN(n)&&!r||(n=isNaN(n)?r.row:n,i=isNaN(i)?r.col:i,o.forEach((function(t,e){var o=s.rows[n+e];if(!o&&s.options.canAddRows){var r=s.rows[n];s.addRows([r.cells.map((function(t){return""}))]),o=s.rows[n+e]}var l=i,a=1===t.length&&""===t[0];o&&!a&&t.forEach((function(t,e){var n=o.cells[l+e];n&&!n.readonly&&(s.setCell(n,t),n.select())}))})))},t.prototype.initClipboard=function(){var t=this,e=i(this.hiddenInput,"paste",(function(e){e.preventDefault();var n=(e.clipboardData||window.clipboardData).getData("text");t.pasteCSV(n,"\t")})),n=i(this.hiddenInput,"copy",(function(e){e.preventDefault();var n=t.activeCell;if(n){for(var i=[],s=n.row;;s++){var o=t.rows[s],r=[];if(!o||!o.cells[n.col]||!o.cells[n.col].selected())break;for(var l=n.col;;++l){var a=o.cells[l];if(!a||!a.selected())break;r.push(a.value())}i.push(r)}(e.clipboardData||window.clipboardData).setData("text/plain",function(t,e,n){void 0===n&&(n="\n");var i="";return t.forEach((function(t,s){s>0&&(i+=n),t.forEach((function(t,n){(t=t.replace(/"/g,'""')).search(/("|,|\n)/g)>=0&&(t='"'+t+'"'),n>0&&(i+=e),i+=t}))})),i}(i,"\t"))}}));this.cleanups.push(e),this.cleanups.push(n)},t.prototype.setCell=function(t,e){t.readonly||(t.set(e),this.updateValue(t,!0))},t.prototype.unselect=function(){var t=!1;return this.cells.forEach((function(e){t=t||e.selected(),e.select(!1)})),t},t.prototype.updateValue=function(t,e){var n=t.col,i=this.options.rows[t.row],s=i[n];"string"==typeof s||"number"==typeof s?i[n]=t.value():s.value=t.value(),e&&this.emitInput(t)},t.prototype.emitInput=function(t){this.events.emit("input",{grid:this,col:t.col,row:t.row,value:t.value()})},t.prototype.emitFocus=function(){var t=this.activeCell;this.events.emit("focus",{grid:this,col:t.col,row:t.row,value:t.value()})},t.prototype.emitSelect=function(){this.events.emit("select",{grid:this,selection:this.cells.filter((function(t){return t.selected()})).map((function(t){return{row:t.row,col:t.col}}))})},t}();function m(t){return"."+t}function y(t){return!1!==t}t.Grid=v,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=celled.min.js.map
